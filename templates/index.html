<!DOCTYPE html>
<html>
<head>
    <title>Sensor Data Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.2/socket.io.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .plot-container { background-color: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        #status { margin-bottom: 15px; padding: 10px; background-color: #e9e9e9; border-radius: 4px; }
        #dominant_freq_display { font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Live Sensor Data Visualization</h1>
    <div id="status">Trạng thái: Đang kết nối...</div>
    <div id="dominant_freq_display">Tần số đặc trưng X: -- Hz, Y: -- Hz, Z: -- Hz</div>

    <div class="container">
        <div class="plot-container">
            <h2>Gia tốc (m/s²)</h2>
            <div id="plotAcc"></div>
        </div>
        <div class="plot-container">
            <h2>FFT Gia tốc X</h2>
            <div id="plotFftX"></div>
        </div>
        <div class="plot-container">
            <h2>Vận tốc (m/s)</h2>
            <div id="plotVel"></div>
        </div>
        <div class="plot-container">
            <h2>FFT Gia tốc Y</h2>
            <div id="plotFftY"></div>
        </div>
        <div class="plot-container">
            <h2>Li độ (m)</h2>
            <div id="plotDisp"></div>
        </div>
        <div class="plot-container">
            <h2>FFT Gia tốc Z</h2>
            <div id="plotFftZ"></div>
        </div>
    </div>

    <script>
        const MAX_DATA_POINTS = 500; // Số điểm dữ liệu tối đa trên đồ thị thời gian

        // Khởi tạo dữ liệu cho đồ thị
        let timeData = [];
        let accXData = [], accYData = [], accZData = [];
        let velXData = [], velYData = [], velZData = [];
        let dispXData = [], dispYData = [], dispZData = [];
        // Không cần lưu trữ fftData vì nó sẽ được vẽ lại hoàn toàn mỗi lần

        const statusDiv = document.getElementById('status');
        const domFreqDiv = document.getElementById('dominant_freq_display');

        // --- Khởi tạo đồ thị Plotly ---
        function initPlot(divId, title, yAxisTitle, traceNames = ['X', 'Y', 'Z']) {
            const traces = traceNames.map((name, index) => ({
                y: [],
                x: [],
                mode: 'lines',
                name: name,
                line: { color: ['red', 'green', 'blue'][index % 3] }
            }));

            Plotly.newPlot(divId, traces, {
                title: title,
                xaxis: { title: 'Thời gian (s)' },
                yaxis: { title: yAxisTitle, autorange: true }, // autorange cho trục y
                margin: { l: 50, r: 30, b: 50, t: 50, pad:4 },
                legend: {orientation: 'h', y: 1.15, yanchor: 'top'}
            });
        }

        function initFFTPlot(divId, title, color = 'red') {
            Plotly.newPlot(divId, [{ x: [], y: [], type: 'scatter', mode: 'lines', line: {color: color} }], {
                title: title,
                xaxis: { title: 'Tần số (Hz)', autorange: true }, // autorange cho trục x của FFT
                yaxis: { title: 'Biên độ', autorange: true },
                margin: { l: 50, r: 30, b: 50, t: 50, pad:4 }
            });
        }

        initPlot('plotAcc', '', 'Gia tốc (m/s²)', ['AccX', 'AccY', 'AccZ']);
        initPlot('plotVel', '', 'Vận tốc (m/s)', ['VelX', 'VelY', 'VelZ']);
        initPlot('plotDisp', '', 'Li độ (m)', ['DispX', 'DispY', 'DispZ']);

        initFFTPlot('plotFftX', '', 'red');
        initFFTPlot('plotFftY', '', 'green');
        initFFTPlot('plotFftZ', '', 'blue');


        // --- Kết nối WebSocket ---
        const socket = io.connect(window.location.protocol + '//' + document.domain + ':' + location.port);

        socket.on('connect', () => {
            statusDiv.textContent = 'Trạng thái: Đã kết nối tới server WebSocket.';
            statusDiv.style.color = 'green';
        });

        socket.on('disconnect', () => {
            statusDiv.textContent = 'Trạng thái: Đã ngắt kết nối khỏi server WebSocket.';
            statusDiv.style.color = 'red';
        });

        socket.on('sensor_data', function(data) {
            // console.log(data); // Debug dữ liệu nhận được
            if (!data || typeof data.ts === 'undefined') return;

            const currentTime = data.ts; // Sử dụng timestamp từ server

            timeData.push(currentTime);
            accXData.push(data.acc_x_filtered);
            accYData.push(data.acc_y_filtered);
            accZData.push(data.acc_z_filtered);
            velXData.push(data.vel_x);
            velYData.push(data.vel_y);
            velZData.push(data.vel_z);
            dispXData.push(data.disp_x);
            dispYData.push(data.disp_y);
            dispZData.push(data.disp_z);

            // Giới hạn số lượng điểm dữ liệu
            if (timeData.length > MAX_DATA_POINTS) {
                timeData.shift();
                accXData.shift(); accYData.shift(); accZData.shift();
                velXData.shift(); velYData.shift(); velZData.shift();
                dispXData.shift(); dispYData.shift(); dispZData.shift();
            }

            // Cập nhật đồ thị dữ liệu theo thời gian
            Plotly.update('plotAcc', {
                x: [timeData, timeData, timeData],
                y: [accXData, accYData, accZData]
            }, {}, [0, 1, 2]); // Cập nhật 3 traces

             Plotly.update('plotVel', {
                x: [timeData, timeData, timeData],
                y: [velXData, velYData, velZData]
            }, {}, [0, 1, 2]);

             Plotly.update('plotDisp', {
                x: [timeData, timeData, timeData],
                y: [dispXData, dispYData, dispZData]
            }, {}, [0, 1, 2]);


            // Cập nhật đồ thị FFT
            if (data.fft_x_freqs && data.fft_x_amps) {
                Plotly.react('plotFftX', [{ x: data.fft_x_freqs, y: data.fft_x_amps, type: 'scatter', mode: 'lines', line: {color: 'red'} }]);
            }
            if (data.fft_y_freqs && data.fft_y_amps) {
                Plotly.react('plotFftY', [{ x: data.fft_y_freqs, y: data.fft_y_amps, type: 'scatter', mode: 'lines', line: {color: 'green'} }]);
            }
            if (data.fft_z_freqs && data.fft_z_amps) {
                Plotly.react('plotFftZ', [{ x: data.fft_z_freqs, y: data.fft_z_amps, type: 'scatter', mode: 'lines', line: {color: 'blue'} }]);
            }

            // Cập nhật tần số đặc trưng
            domFreqDiv.textContent = `Tần số đặc trưng X: ${data.dominant_freq_x.toFixed(2)} Hz, Y: ${data.dominant_freq_y.toFixed(2)} Hz, Z: ${data.dominant_freq_z.toFixed(2)} Hz`;
        });

        // Giảm tần suất relayout để tối ưu hiệu năng
        // Plotly.react thay vì Plotly.update có thể hiệu quả hơn cho việc vẽ lại toàn bộ
        // Tuy nhiên, Plotly.update cho phép cập nhật từng trace riêng.
        // Với dữ liệu stream, việc quản lý data arrays và dùng Plotly.update/extendTraces là cần thiết.

    </script>
</body>
</html>